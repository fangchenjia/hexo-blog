---
title: 王者荣耀移动端全栈项目上线心得
toc: true
comments: true
tags:
  - vue
  - node
  - 全栈
categories:
  - vue
description:
  - 刚刚做完一个练手的全栈项目，记录其中一些不太熟练知识点
abbrlink: 1cc8d827
date: 2021-04-25 14:14:30
updated: 2021-04-25 14:14:30
---

## vue-cli 配置文件

> 在进行开发过程中 axios 的 baseURL 填的是`localhost:3000`;
> 这样上线肯定是不行的;
> 可以添加 vue-cli 环境变量进行配置;

<!-- more -->

项目根目录中放置下列文件来指定环境变量：

```
.env                # 在所有的环境中被载入
.env.local          # 在所有的环境中被载入，但会被 git 忽略
.env.[mode]         # 只在指定的模式中被载入
.env.[mode].local   # 只在指定的模式中被载入，但会被 git 忽略
```

我在根目录下创建了`.env.development`,并且配置`VUE_APP_API_UR`用于开发阶段测试：

```
VUE_APP_API_URL=http://localhost:3000/admin/api/
```

axios：

```
const http = axios.create({
    baseURL: process.env.VUE_APP_API_URL || '/admin/api/',
    //baseURL: 'http://localhost:3000/admin/api/'
})
```

> 添加`vue.config.js`配置文件可以进行 cli 的全局配置

```
module.exports = {
  outputDir: __dirname + '/../server/admin', //生成的文件放到哪里
  publicPath: process.env.NODE_ENV === 'production' ? '/admin' : '/'  //生成的文件在引用css/js/等文件时的路径
}
```

结论： 遇到不懂的就去翻官方文档

## node 使用 multer 上传文件到阿里云

```
const multer = require('multer')
//使用阿里云oss
const MAO = require('multer-aliyun-oss')

const upload = multer({
    storage: MAO({
        config: {
            region: '<region>', //例如'oss-cn-zhangjiakou'
            accessKeyId: '<accessKeyId>', //阿里云控制台获取
            accessKeySecret: '<accessKeySecret>',
            bucket: '<bucket>' //创建的对象桶的名称，我的是'vue-node-wzry'
        }
    })
})

app.post('/admin/api/upload', upload.sing('file'), (req, res, next) => {
    const file = req.file
    res.json(file)
})

```

## 使用 nginx 反向代理

> 通过配置 nginx 可以实现不同域名访问不同端口,以及同一个域名访问其他服务器进行负载均衡等

> 我的服务器主要跑着我的博客以及一些练手的项目，所以通过配置实现了用二级域名访问不同的端口从而访问不同的项目

- 我的服务器是 centos7，通过 Xshell 连接上 linux 服务器后(已经安装了 nginx)

```bash
vi /etc/nginx/nginx.conf
```

添加配置

```
#王者荣耀项目
server {
    listen       80;
    #通过什么域名访问
    server_name  wzry.cosycosy.cn;
    #代理的服务器以及端口
    location / {
        proxy_pass http://146.56.216.194:3000;
    }
    #rewrite配置用来强制使用HTTPS
    rewrite ^/(.*)$ https://wzry.cosycosy.cn:443/$1 permanent;
}
```

- 添加 ssl 证书从而使用 HTTPS 访问
- 首先要先申请 ssl 证书并下载，会得到一个压缩包
- 把下载的证书及公钥移到 /etc/ssl 目录下
- 1_wzry.cosycosy.cn_bundle.crt;
- 2_wzry.cosycosy.cn.key 这是我从下载的 ssl 证书压缩包解压出来的文件

```
#王者荣耀项目ssl
server {
    listen       443 ssl;
    #        listen       [::]:443 ssl http2 default_server;
    server_name  wzry.cosycosy.cn;
    #更改成对应的文件
    ssl_certificate /etc/ssl/1_wzry.cosycosy.cn_bundle.crt;
    ssl_certificate_key /etc/ssl/2_wzry.cosycosy.cn.key;

    ssl_session_cache shared:SSL:1m;
    ssl_session_timeout  10m;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on

    #代理的服务器以及端口
    location / {
            proxy_pass http://146.56.216.194:3000;
    }
}


```

## 使用 pm2

1. 安装

```
npm install -y pm2 -g
```

pm2 -v 查看是否安装成功

2. 使用

- 进入项目目录
  找到启动文件如 app.js

```
pm2 start app.js
```

常用的一些使用命令

```
pm2 list            //列出PM2管理的所有应用程序
pm2 stop www        //停止项目名为www的应用程序
pm2 stop all        //停止pm2管理的所有应用程序
pm2 restart www     //重启项目名为www的应用程序
pm2 reload www      //重载项目名为www的应用程序
pm2 logs            //查看日志
```

## mongoose 数据库的迁移

> 刚部署到线上时数据库是没有数据的可通过 mongodb 的一些命令把本地数据库迁移到线上

1.本地

```
mongodump -d 数据库名称
mongodump -d vue-node-wzry
```

会生成一个 dump 文件夹
里面有 vue-node-wzry(每个数据库都有对应的一个文件夹)

2.线上

把生成的文件夹移到服务器上，在和文件同一级目录下运行：

```
mongorestore dump/
```

这样数据库就完成了迁移
